<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <title>Valet Ops Live – History</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <link rel="stylesheet" href="style.css" />

    <!-- Supabase v1 global -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@1.35.7/dist/umd/supabase.min.js"></script>
    <!-- Our app logic (shared renderer + data) -->
    <script type="module" src="app.js"></script>

    <style>
      /* History-only: keep it readable and aligned without affecting other pages */
      .history-wrap {
        padding: 0.75rem 1rem 1.5rem;
        max-width: 1800px;
        margin: 0 auto;
      }
      .history-controls {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
        margin: 0.75rem 0;
      }
      .history-controls .input-text {
        min-width: 220px;
      }
      .history-hint {
        font-size: 0.8rem;
        color: #a0a0a0;
        margin-top: 0.25rem;
      }
      .history-grid {
        display: grid;
        grid-template-columns: 1fr;
        gap: 0.75rem;
      }
      .history-card {
        border: 1px solid #181820;
        border-radius: 10px;
        background: #06060c;
        overflow: hidden;
      }
      .history-card-head {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: baseline;
        justify-content: space-between;
        padding: 0.65rem 0.8rem;
        border-bottom: 1px solid #17171f;
        background: #101018;
      }
      .history-card-title {
        display: flex;
        flex-wrap: wrap;
        gap: 0.5rem;
        align-items: center;
      }
      .history-card-meta {
        font-size: 0.78rem;
        color: #a0a0a0;
      }
      .history-card-body {
        padding: 0.75rem 0.8rem 0.9rem;
        display: grid;
        grid-template-columns: minmax(260px, 1.1fr) minmax(260px, 0.9fr);
        gap: 0.75rem;
        align-items: start;
      }
      @media (max-width: 900px) {
        .history-card-body {
          grid-template-columns: 1fr;
        }
      }
      .history-block {
        border: 1px solid #17171f;
        background: #05050b;
        border-radius: 10px;
        padding: 0.6rem 0.7rem;
      }
      .history-block-title {
        font-size: 0.75rem;
        color: #a0a0a0;
        text-transform: uppercase;
        letter-spacing: 0.08em;
        margin-bottom: 0.35rem;
      }
      .history-line {
        font-size: 0.82rem;
        margin: 0.18rem 0;
        color: #f5f5f5;
      }
      .history-line.dim {
        color: #9ca3af;
      }
      .history-notes {
        white-space: pre-wrap;
        font-size: 0.82rem;
        color: #e5e7eb;
        line-height: 1.35;
      }
      .history-row-actions {
        display: flex;
        flex-wrap: wrap;
        gap: 0.35rem;
        margin-top: 0.55rem;
      }
      .pill {
        display: inline-flex;
        align-items: center;
        padding: 0.12rem 0.45rem;
        border-radius: 999px;
        border: 1px solid #3a3a3a;
        background: #05050b;
        font-size: 0.72rem;
        letter-spacing: 0.06em;
        text-transform: uppercase;
        color: #d0d0d0;
      }
      .pill.ok {
        border-color: #204d2a;
        background: #0b1b10;
        color: #a9ffb7;
      }
      .pill.warn {
        border-color: #7a4418;
        background: #221109;
        color: #ffb47a;
      }
      .pill.bad {
        border-color: #7a1c1c;
        background: #220a0a;
        color: #ff9b9b;
      }
    </style>
  </head>

  <body class="role-dispatcher">
    <div class="app-shell">
      <header class="app-header">
        <img src="assets/optima-logo.jpg" alt="Optima Dealer Services" class="logo" />
        <div class="titles">
          <div class="brand">Optima Dealer Services</div>
          <div class="subtitle">History – Completed & Full Timeline</div>
        </div>

        <div class="header-right">
          <a class="btn small" href="dispatcher.html">Back</a>
          <div class="role-pill">History</div>
        </div>
      </header>

      <main class="history-wrap">
        <section class="section">
          <div class="section-header">
            <div>
              <div class="section-title">
                Completed Tickets
                <span class="section-count" id="history-count">0</span>
              </div>
              <div class="section-subtitle">
                Schema-locked view. This page uses the same underlying data as dispatcher.
              </div>
            </div>
          </div>

          <div class="history-controls">
            <input id="history-search" class="input-text" placeholder="Search tag or customer…" />
            <select id="history-range" class="input-text" style="min-width: 180px;">
              <option value="today">Today</option>
              <option value="7">Last 7 days</option>
              <option value="30">Last 30 days</option>
              <option value="all">All time</option>
            </select>
            <button id="history-refresh" class="btn btn-primary">Refresh</button>
            <div class="history-hint">
              Tip: Use the “Timeline” button to view the full audit trail pop-up.
            </div>
          </div>

          <div id="history-grid" class="history-grid">
            <!-- Filled by JS -->
          </div>
        </section>
      </main>
    </div>

    <script type="module">
      import { supabase } from "./supabaseClient.js";

      // IMPORTANT:
      // - We keep schema locked by rendering fixed "cards" (not tables)
      // - We do NOT alter any data model or behavior.
      // - Timeline uses the same popup logic style as app.js.

      const grid = document.getElementById("history-grid");
      const countEl = document.getElementById("history-count");
      const searchEl = document.getElementById("history-search");
      const rangeEl = document.getElementById("history-range");
      const refreshBtn = document.getElementById("history-refresh");

      let rows = [];

      const fmtTime = (iso) => {
        if (!iso) return "";
        const d = new Date(iso);
        return (
          d.toLocaleDateString(undefined, { month: "short", day: "numeric" }) +
          " " +
          d.toLocaleTimeString(undefined, { hour: "2-digit", minute: "2-digit" })
        );
      };

      const esc = (str) =>
        String(str ?? "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;");

      const formatDuration = (seconds) => {
        if (!seconds || seconds < 0) seconds = 0;
        const snapped = Math.round(seconds / 15) * 15;
        const mins = Math.floor(snapped / 60);
        const secs = snapped % 60;
        return `${mins}m ${secs.toString().padStart(2, "0")}s`;
      };

      const computeSeconds = (startIso, endIso, now) => {
        if (!startIso) return 0;
        const start = new Date(startIso);
        let end = endIso ? new Date(endIso) : now;
        if (end < start) end = now;
        const diffMs = end - start;
        if (Number.isNaN(diffMs) || diffMs < 0) return 0;
        return diffMs / 1000;
      };

      const computeMasterSeconds = (p, now) => {
        const startIso = p.active_started_at || p.created_at;
        if (!startIso) return 0;
        const endIso = p.waiting_client_at || null;
        return computeSeconds(startIso, endIso, now);
      };

      const severityPill = (seconds) => {
        const mins = seconds / 60;
        if (mins >= 25) return `<span class="pill bad">SLOW</span>`;
        if (mins >= 20) return `<span class="pill warn">WATCH</span>`;
        return `<span class="pill ok">OK</span>`;
      };

      const latestNote = (p) => {
        const notes = (p.notes || "").split("\n").filter(Boolean);
        return notes.length ? notes[notes.length - 1] : "";
      };

      function buildTimelineText(p) {
        const lines = [];
        lines.push(`Ticket ${p.tag_number} – ${p.customer_name}`);
        lines.push("--------------------------------");
        if (p.created_at) lines.push("Created: " + fmtTime(p.created_at));
        if (p.active_started_at) lines.push("Entered Active Pickups: " + fmtTime(p.active_started_at));
        if (p.keys_with_valet_at && p.keys_holder) lines.push(`Keys with ${p.keys_holder}: ` + fmtTime(p.keys_with_valet_at));
        if (p.keys_at_machine_at) lines.push("Keys in key machine: " + fmtTime(p.keys_at_machine_at));
        if (p.wash_status_at && p.wash_status && p.wash_status !== "NONE") lines.push(`Wash status: ` + fmtTime(p.wash_status_at));
        if (p.waiting_client_at) lines.push("Waiting/staged for customer: " + fmtTime(p.waiting_client_at));
        if (p.completed_at) lines.push("Completed: " + fmtTime(p.completed_at));

        const masterSeconds = computeMasterSeconds(p, new Date());
        lines.push("Master cycle (Active box in/out): " + formatDuration(masterSeconds));

        if (p.notes) {
          lines.push("");
          lines.push("Notes history:");
          p.notes.split("\n").forEach((n) => lines.push("• " + n));
        }
        return lines.join("\n");
      }

      function render() {
        const q = (searchEl.value || "").trim().toLowerCase();
        const now = new Date();

        let filtered = rows.slice();

        // Range filter
        const range = rangeEl.value;
        if (range !== "all") {
          let since = new Date();
          if (range === "today") {
            since.setHours(0, 0, 0, 0);
          } else {
            since = new Date(now.getTime() - Number(range) * 24 * 60 * 60 * 1000);
          }
          filtered = filtered.filter((p) => p.completed_at && new Date(p.completed_at) >= since);
        }

        // Search filter
        if (q) {
          filtered = filtered.filter((p) => {
            const tag = String(p.tag_number || "").toLowerCase();
            const name = String(p.customer_name || "").toLowerCase();
            return tag.includes(q) || name.includes(q);
          });
        }

        if (countEl) countEl.textContent = String(filtered.length);

        if (!filtered.length) {
          grid.innerHTML = `<div class="empty">No matching tickets.</div>`;
          return;
        }

        grid.innerHTML = filtered
          .map((p) => {
            const masterSeconds = computeMasterSeconds(p, now);
            const note = latestNote(p);
            const deliveredBy = p.keys_holder || "—";

            return `
              <div class="history-card">
                <div class="history-card-head">
                  <div class="history-card-title">
                    <span class="cell-tag">${esc(p.tag_number)}</span>
                    <span class="cell-customer">${esc(p.customer_name)}</span>
                    ${severityPill(masterSeconds)}
                  </div>
                  <div class="history-card-meta">
                    Completed: ${esc(fmtTime(p.completed_at))}
                  </div>
                </div>

                <div class="history-card-body">
                  <div class="history-block">
                    <div class="history-block-title">Timeline Summary</div>
                    <div class="history-line">Created: <span class="dim">${esc(fmtTime(p.created_at))}</span></div>
                    <div class="history-line">Delivered by: <span class="dim">${esc(deliveredBy)}</span></div>
                    <div class="history-line">Master time: <span class="dim">${esc(formatDuration(masterSeconds))}</span></div>
                    <div class="history-row-actions">
                      <button class="btn small" data-action="timeline" data-id="${p.id}">Timeline</button>
                    </div>
                  </div>

                  <div class="history-block">
                    <div class="history-block-title">Latest Note</div>
                    <div class="history-notes">${esc(note || "—")}</div>
                  </div>
                </div>
              </div>
            `;
          })
          .join("");
      }

      async function load() {
        grid.innerHTML = `<div class="empty">Loading…</div>`;

        const { data, error } = await supabase
          .from("pickups")
          .select("*")
          .eq("status", "COMPLETE")
          .order("completed_at", { ascending: false })
          .limit(200);

        if (error) {
          console.error(error);
          grid.innerHTML = `<div class="empty">Error loading history. Check console.</div>`;
          return;
        }

        rows = data || [];
        render();
      }

      // Events
      refreshBtn.addEventListener("click", () => load());
      searchEl.addEventListener("input", () => render());
      rangeEl.addEventListener("change", () => render());

      // Timeline click (delegated)
      grid.addEventListener("click", (e) => {
        const btn = e.target.closest("[data-action]");
        if (!btn) return;
        const action = btn.getAttribute("data-action");
        if (action !== "timeline") return;

        const id = btn.getAttribute("data-id");
        const p = rows.find((x) => String(x.id) === String(id));
        if (!p) return;
        alert(buildTimelineText(p));
      });

      load();
    </script>
  </body>
</html>
